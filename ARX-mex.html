<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tecno-mex | سوق شامل</title>
    <meta
      name="description"
      content="سوق إلكتروني شامل لبيع وشراء المنتجات التقنية والإلكترونية"
    />
    <meta property="og:title" content="Tecno-mex - سوق إلكتروني شامل" />
    <meta property="og:description" content="بيع وشراء كل شيء!" />
    <meta name="theme-color" content="#00aaff" />

    <!-- تحسينات تحميل الموارد -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap"
    />

    <style>
      /* CSS الحرجة - فوق الطية */
      header,
      nav {
        opacity: 1 !important;
      }

      /* تحسينات لـ LCP */
      .lcp-image {
        width: 100%;
        height: auto;
        max-width: 100%;
        aspect-ratio: 16/9;
      }

      /* تحسينات عامة */
      :root {
        --primary: #00aaff;
        --secondary: #0088cc;
        --text: #333;
        --light-gray: #f5f5f5;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        margin: 0;
        font-family: "Tajawal", "Segoe UI", sans-serif;
        background-color: #f4f4f4;
        color: var(--text);
        line-height: 1.6;
      }

      header {
        background-color: #000;
        color: var(--primary);
        padding: 20px;
        text-align: center;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
      }

      header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          135deg,
          rgba(0, 0, 0, 0.8) 0%,
          rgba(0, 0, 0, 0.6) 100%
        );
        z-index: -1;
      }

      header h1 {
        font-size: 3.5rem;
        margin-bottom: 1rem;
        color: #fff;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      header h2 {
        font-size: 1.8rem;
        font-weight: 400;
        color: var(--primary);
        max-width: 800px;
      }

      nav {
        text-align: center;
        margin-top: 10px;
        padding: 20px 0;
        background: #fff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      nav button {
        margin: 5px;
        padding: 12px 25px;
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      nav button:hover {
        background-color: var(--secondary);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .products,
      .admin-section {
        display: none;
      }

      .products.active,
      .admin-section.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .products {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
      }

      .category {
        margin-bottom: 40px;
      }

      .category h3 {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        font-size: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        margin-bottom: 25px;
      }

      .product-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 30px;
      }

      .product {
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid #eee;
        position: relative;
      }

      .product:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
      }

      .product-badge {
        position: absolute;
        top: 15px;
        left: 15px;
        background: var(--primary);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        z-index: 2;
      }

      .product img {
        width: 100%;
        height: 220px;
        object-fit: cover;
        border-bottom: 1px solid #eee;
        display: block;
      }

      .product-content {
        padding: 25px;
      }

      .product h3 {
        margin: 0 0 15px 0;
        font-size: 1.3rem;
        color: #333;
        font-weight: 700;
      }

      .product p {
        font-size: 0.95rem;
        color: #666;
        line-height: 1.6;
        margin: 10px 0;
      }

      .product .price {
        font-weight: bold;
        color: var(--primary);
        font-size: 1.3rem;
        margin: 15px 0;
        display: block;
      }

      .product-links {
        display: flex;
        gap: 12px;
        margin-top: 20px;
      }

      .product-links a {
        flex: 1;
        text-align: center;
        padding: 12px;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
        text-decoration: none;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .product-links a:first-child {
        background-color: #25d366;
        color: white;
      }

      .product-links a:last-child {
        background-color: var(--secondary);
        color: white;
      }

      .product-links a:hover {
        opacity: 0.9;
        transform: translateY(-2px);
      }

      .admin-section {
        padding: 40px 20px;
        background-color: #fff;
        margin: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
        max-width: 800px;
        margin: 40px auto;
      }

      .admin-section h2 {
        text-align: center;
        margin-bottom: 30px;
        color: var(--primary);
        font-size: 2rem;
      }

      .admin-section input,
      .admin-section textarea,
      .admin-section select,
      .admin-section button {
        width: 100%;
        margin: 15px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 1rem;
        font-family: inherit;
        transition: all 0.3s;
      }

      .admin-section input:focus,
      .admin-section textarea:focus,
      .admin-section select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.2);
        outline: none;
      }

      .admin-section button {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        font-weight: bold;
        font-size: 1.1rem;
        border: none;
        cursor: pointer;
        padding: 16px;
        margin-top: 20px;
      }

      .admin-section button:hover {
        opacity: 0.9;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .image-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin: 15px 0;
      }

      .image-preview img {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid #eee;
      }

      .success,
      .error {
        text-align: center;
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        font-weight: bold;
        font-size: 1.1rem;
      }

      footer {
        text-align: center;
        padding: 40px 20px;
        background: #000;
        color: #aaa;
        margin-top: 60px;
      }

      @media (max-width: 768px) {
        .product-list {
          grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        }

        header h1 {
          font-size: 2.5rem;
        }

        header h2 {
          font-size: 1.4rem;
        }

        .admin-section {
          margin: 20px;
          padding: 30px 15px;
        }
      }

      @media (max-width: 480px) {
        .product-list {
          grid-template-columns: 1fr;
        }

        .product-links {
          flex-direction: column;
        }

        header h1 {
          font-size: 2rem;
        }

        header h2 {
          font-size: 1.2rem;
        }
      }

      /* تحسينات للأداء */
      img,
      video,
      iframe {
        width: 100%;
        height: auto;
        max-width: 100%;
      }

      .product {
        min-height: 450px;
      }
    </style>

    <!-- تحميل خط Tajawal بدون عرقلة العرض -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap"
      media="print"
      onload="this.media='all'"
    />
  </head>
  <body>
    <!-- تحسين هيكلة العناوين -->
    <header role="banner">
      <h1>Tecno-mex</h1>
      <h2>سوق إلكتروني شامل - بيع وشراء كل شيء!</h2>
    </header>

    <nav>
      <button onclick="showSection('products')">عرض المنتجات</button>
      <button onclick="showSection('admin')">إضافة منتج</button>
    </nav>

    <section class="products active" id="products">
      <!-- سيتم ملؤها بالمنتجات عبر JS -->
      <div class="loader" id="loader" style="text-align: center; padding: 50px">
        <div
          style="
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 170, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00aaff;
            animation: spin 1s ease-in-out infinite;
          "
        ></div>
        <p style="margin-top: 20px; font-weight: bold">
          جاري تحميل المنتجات...
        </p>
      </div>
    </section>

    <section class="admin-section" id="admin">
      <h2>إضافة منتج جديد</h2>
      <form id="productForm">
        <input type="text" name="name" placeholder="اسم المنتج" required />
        <input type="number" name="price" placeholder="سعر المنتج" required />

        <select name="category" required>
          <option value="إلكترونيات">إلكترونيات</option>
          <option value="ملابس">ملابس</option>
          <option value="أثاث">أثاث</option>
          <option value="مركبات">مركبات</option>
          <option value="ألعاب">ألعاب</option>
          <option value="أدوات منزلية">أدوات منزلية</option>
          <option value="أشياء أخرى">أشياء أخرى</option>
        </select>

        <textarea
          name="desc"
          placeholder="وصف المنتج"
          required
          rows="4"
        ></textarea>

        <label for="img1">صورة المنتج الرئيسية (مطلوبة)</label>
        <input type="file" name="img1" id="img1" accept="image/*" required />
        <div class="image-preview" id="preview1"></div>

        <label for="img2">صورة إضافية (اختيارية)</label>
        <input type="file" name="img2" id="img2" accept="image/*" />
        <div class="image-preview" id="preview2"></div>

        <label for="img3">صورة إضافية (اختيارية)</label>
        <input type="file" name="img3" id="img3" accept="image/*" />
        <div class="image-preview" id="preview3"></div>

        <input type="url" name="whatsapp" placeholder="رابط واتساب" required />
        <input type="url" name="telegram" placeholder="رابط تلغرام" />

        <button type="submit">نشر المنتج</button>

        <div
          class="success"
          id="successMsg"
          style="color: green; display: none"
        >
          ✅ تمت الإضافة بنجاح
        </div>

        <div class="error" id="errorMsg" style="color: red; display: none">
          ❌ حدث خطأ أثناء الإرسال
        </div>
      </form>
    </section>

    <footer>
      <p>&copy; 2025 Tecno-mex. جميع الحقوق محفوظة.</p>
      <p style="margin-top: 10px">
        سوق شامل لبيع وشراء المنتجات التقنية والإلكترونية
      </p>
    </footer>

    <script>
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbxBga85OaJnQZG5jaGZOzB7Tyk7lE58tmI8wwt2DfeMoJf39BI6pqI5VM2G3TBWr4tYcw/exec";

      // تحسينات لـ LCP
      function optimizeLCP() {
        const lcpCandidate =
          document.querySelector("header") ||
          document.querySelector(".product:first-child img");

        if (lcpCandidate) {
          // تحسينات لـ LCP
          lcpCandidate.style.willChange = "transform, opacity";
          lcpCandidate.style.transform = "translateZ(0)";
        }

        // تحميل الصور المرئية أولاً
        const lazyImages = document.querySelectorAll("img:not([data-loaded])");
        lazyImages.forEach((img) => {
          if (img.dataset.src) {
            img.src = img.dataset.src;
            img.dataset.loaded = true;
          }
        });
      }

      function showSection(section) {
        document.getElementById("products").classList.remove("active");
        document.getElementById("admin").classList.remove("active");
        document.getElementById(section).classList.add("active");

        // تحسين تجربة المستخدم
        if (section === "products") {
          loadProducts();
        }
      }

      // معاينة الصور
      ["img1", "img2", "img3"].forEach((id) => {
        document.getElementById(id).addEventListener("change", (e) => {
          const previewId = "preview" + id.slice(-1);
          const preview = document.getElementById(previewId);
          preview.innerHTML = "";

          if (e.target.files.length > 0) {
            const reader = new FileReader();
            reader.onload = (event) => {
              const img = document.createElement("img");
              img.src = event.target.result;
              preview.appendChild(img);
            };
            reader.readAsDataURL(e.target.files[0]);
          }
        });
      });

      const form = document.getElementById("productForm");
      const successMsg = document.getElementById("successMsg");
      const errorMsg = document.getElementById("errorMsg");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // إظهار تحميل
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.textContent;
        submitBtn.textContent = "جاري النشر...";
        submitBtn.disabled = true;

        const formData = new FormData(form);

        const getBase64 = (file) =>
          new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
          });

        const data = {
          name: formData.get("name"),
          category: formData.get("category"),
          desc: formData.get("desc"),
          price: formData.get("price"),
          whatsapp: formData.get("whatsapp"),
          telegram: formData.get("telegram"),
        };

        // رفع الصور كـ Base64
        for (let idx = 0; idx < 3; idx++) {
          const file = document.getElementById(`img${idx + 1}`).files[0];
          if (file) {
            data[`image${idx + 1}`] = await getBase64(file);
          }
        }

        try {
          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            body: new URLSearchParams(data),
          });

          const result = await response.json();

          if (result.status === "success") {
            form.reset();
            ["preview1", "preview2", "preview3"].forEach((id) => {
              document.getElementById(id).innerHTML = "";
            });
            successMsg.style.display = "block";
            errorMsg.style.display = "none";

            // تحديث قائمة المنتجات بعد الإضافة
            await loadProducts();

            setTimeout(() => {
              showSection("products");
              successMsg.style.display = "none";
            }, 2000);
          } else {
            throw new Error("فشل الإضافة");
          }
        } catch (err) {
          errorMsg.style.display = "block";
          successMsg.style.display = "none";
          console.error(err);
        } finally {
          submitBtn.textContent = originalBtnText;
          submitBtn.disabled = false;
        }
      });

      async function loadProducts() {
        try {
          // إظهار تحميل
          const loader = document.getElementById("loader");
          const container = document.getElementById("products");
          if (loader) loader.style.display = "block";

          // استخدم AbortController لتجنب طلبات متعددة
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000);

          const response = await fetch(SCRIPT_URL, {
            signal: controller.signal,
          });
          clearTimeout(timeoutId);

          const products = await response.json();
          const categories = {};

          products.forEach((p) => {
            const cat = p["نوع المنتج"] || "أشياء أخرى";
            if (!categories[cat]) categories[cat] = [];
            categories[cat].push(p);
          });

          container.innerHTML = "";

          // متغير لتتبع الصورة الأولى (LCP)
          let isFirstImage = true;

          Object.entries(categories).forEach(([cat, items]) => {
            const section = document.createElement("div");
            section.className = "category";
            section.innerHTML = `<h3>${cat}</h3><div class="product-list"></div>`;
            const list = section.querySelector(".product-list");

            items.forEach((prod) => {
              const div = document.createElement("div");
              div.className = "product";

              // إضافة شارة حسب الفئة
              let badge = "";
              if (cat === "إلكترونيات")
                badge = '<div class="product-badge">جديد</div>';
              else if (cat === "مركبات")
                badge =
                  '<div class="product-badge" style="background:#e74c3c;">خصم</div>';

              div.innerHTML = `
              ${badge}
              <img 
                ${
                  isFirstImage
                    ? 'loading="eager" fetchpriority="high"'
                    : 'loading="lazy"'
                } 
                src="${prod["صورة 1"]}" 
                alt="${prod["اسم المنتج"]}"
                class="${isFirstImage ? "lcp-image" : ""}"
              >
              <div class="product-content">
                <h3>${prod["اسم المنتج"]}</h3>
                <p>${prod["وصف المنتج"]}</p>
                <span class="price">💰 ${prod["السعر"]} ل.س</span>
                <div class="product-links">
                  <a href="${prod["واتساب"]}" target="_blank">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                      <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                    </svg>
                    واتساب
                  </a>
                  ${
                    prod["تلغرام"]
                      ? `
                  <a href="${prod["تلغرام"]}" target="_blank">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                      <path d="M9.78,18.65L10.06,14.42L17.74,7.5C18.08,7.19 17.67,7.04 17.22,7.31L7.74,13.3L3.64,12C2.76,11.75 2.75,11.14 3.84,10.7L19.81,4.54C20.54,4.21 21.24,4.72 20.96,5.84L18.24,18.65C18.05,19.56 17.5,19.78 16.74,19.36L12.6,16.3L10.61,18.23C10.38,18.46 10.19,18.65 9.78,18.65Z"/>
                    </svg>
                    تلغرام
                  </a>`
                      : ""
                  }
                </div>
              </div>
            `;
              list.appendChild(div);

              // بعد أول صورة، نغير الأولوية لباقي الصور
              if (isFirstImage) {
                isFirstImage = false;
              }
            });

            container.appendChild(section);
          });
        } catch (err) {
          console.error("Load Error", err);
          container.innerHTML = `
          <div style="text-align: center; padding: 50px;">
            <h3 style="color: #e74c3c;">حدث خطأ أثناء تحميل المنتجات</h3>
            <p>الرجاء المحاولة مرة أخرى</p>
            <button onclick="loadProducts()" style="margin-top: 20px; padding: 10px 20px; background: #00aaff; color: white; border: none; border-radius: 5px; cursor: pointer;">إعادة المحاولة</button>
          </div>
        `;
        } finally {
          const loader = document.getElementById("loader");
          if (loader) loader.style.display = "none";
        }
      }

      // تحميل المنتجات عند فتح الصفحة
      document.addEventListener("DOMContentLoaded", () => {
        loadProducts();
        optimizeLCP();

        // إضافة تحميل متدرج للصور
        const images = document.querySelectorAll("img");
        images.forEach((img) => {
          img.dataset.src = img.src;
          img.src =
            'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 6"%3E%3C/svg%3E';
        });

        // تحسين LCP بعد 500ms
        setTimeout(optimizeLCP, 500);
      });
    </script>
  </body>
</html>
